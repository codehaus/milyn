<project name="junit-test" default="test">
	<description>JUnit Testing.</description>

    <!-- Set the properties. -->
	<property file="build.properties" />
	<property name="test.src" value="${test.root}/src" />
	<property name="test.classes" value="${test.root}/classes" />
	<property name="test.report" value="${test.root}/report" />
	<property name="testCdrar" value="${build.root}/test/testCdrar" />
	<property name="testCdrar.src" value="${testCdrar}/src" />
	<property name="testCdrar.classes" value="${testCdrar}/classes" />
	<property name="test-cdrars-maint" value="${build.root}/test/test-cdrars-maint" />

    <!-- Set the classpath. -->
	<path id="build.classpath">
		<pathelement location="${test.classes}"/>
		<pathelement location="${test.src}"/>
		<pathelement location="${build.root}/classes"/>
		<pathelement location="${build.root}/src"/>
		<pathelement location="${mock.classes}"/>
		<fileset dir="${build.lib}" includes="*.jar"/>
		<fileset dir="${test.lib}" includes="*.jar"/>
	</path>


	<target name="test" depends="compile-tests" description="Execute JUnit Tests.">
		<mkdir dir="${test.report}" />
		<delete failonerror="false">
			<fileset dir="${test.report}" includes="TEST-*.xml"/>
		</delete>

		<junit printsummary="yes" failureproperty="test.unit.failure" fork="on" dir=".">
			<classpath refid="build.classpath" />
			<formatter type="xml"/>
			<batchtest fork="yes" todir="${test.report}">
				<fileset dir="${test.src}">
					<include name="**/${select.unittest.target}Test.java"/>
				</fileset>
			</batchtest>
		</junit>

		<junitreport todir="${test.report}">
			<fileset dir="${test.report}">
				<include name="TEST-*.xml"/>
			</fileset>
			<report todir="${test.report}"/>
		</junitreport>

		<echo message="*** Unit test report at: ${test.report}" />

		<antcall target="assert-test-fail" />
	</target>

	<target name="assert-test-fail" if="test.unit.failure">
		<fail message="Some unit tests have failed.  See report at: ${test.report}" />
	</target>

	<target name="fail-on-test-failure" if="test.unit.failure">
		<fail message="Some unit tests have failed.  See report at: ${test.report}" />
	</target>

	<target name="compile-tests">
		<delete quiet="true" dir="${test.classes}" />
		<mkdir dir="${test.classes}" />
		<javac srcdir="${test.src}" destdir="${test.classes}" debug="on">
			<classpath refid="build.classpath" />
		</javac>
		<delete quiet="true"  dir="${testCdrar.classes}" />
		<mkdir dir="${testCdrar.classes}" />
		<javac srcdir="${testCdrar.src}" destdir="${testCdrar.classes}" debug="on">
			<classpath refid="build.classpath" />
		</javac>
		<javac srcdir="${test-cdrars-maint}/CDRClassLoaderTest" destdir="${test-cdrars-maint}/CDRClassLoaderTest" debug="on">
			<classpath refid="build.classpath" />
		</javac>
			
		<delete quiet="true" file="${testCdrar.src}/../testCdrar.cdrar" />
        <jar destfile="${testCdrar.src}/../testCdrar.cdrar" >
            <fileset dir="${testCdrar.classes}" />
            <fileset dir="${testCdrar.src}" excludes="**/*.java" />
        </jar>
		<antcall target="cdrar">
			<param name="cdrar.folder" value="CDRClassLoaderTest" />
		</antcall>
		<antcall target="cdrar">
			<param name="cdrar.folder" value="MissingADFResource" />
		</antcall>
		<antcall target="cdrar">
			<param name="cdrar.folder" value="NotOK" />
		</antcall>
		<antcall target="cdrar">
			<param name="cdrar.folder" value="OK" />
		</antcall>
	</target>

	<target name="cdrar">
		<property name="cdrar.folder.path" value="${test.root}/../test-cdrars-maint/${cdrar.folder}"/>
		
		<javac srcdir="${cdrar.folder.path}" destdir="${cdrar.folder.path}" debug="on">
			<classpath refid="build.classpath" />
		</javac>
        <delete file="${test.src}/org/milyn/cdr/cdrar/${cdrar.folder}.cdrar" />
        <jar destfile="${test.src}/org/milyn/cdr/cdrar/${cdrar.folder}.cdrar" >
            <fileset dir="${cdrar.folder.path}" />
        </jar>
	</target>
	
	<target name="clean" description="Clean.">
		<delete quiet="true"  dir="${test.classes}" />
		<delete quiet="true"  dir="${test.report}" />
		<delete quiet="true"  dir="${testCdrar.classes}" />
		<delete quiet="true"  dir="${testCdrar}" includes="**/*.class" />
		<delete quiet="true" file="${testCdrar.src}/../testCdrar.cdrar" />
		<delete quiet="true"  dir="${test-cdrars-maint}/CDRClassLoaderTest" includes="**/*.class" />
	</target>
</project>

