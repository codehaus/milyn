<project name="Tinak Project Ant build script" default="build">
	<description>Tinak Project</description>

    <!-- Set the properties. -->
	<property file="build.properties" />
    <!-- The version should get set by the release target -->
	<property name="tinak.version" value="x.x.x" />
	<property name="build.dtd.package" value="${build.classes}/org/milyn/dtd" />
	<property name="taglib.root" value="${build.root}/taglib" />
	<property name="taglib.src" value="${taglib.root}/src" />
	<property name="taglib.classes" value="${taglib.root}/classes" />
	<property name="mock.src" value="${build.root}/test/mock/src" />
	<property name="mock.classes" value="${build.root}/test/mock/classes" />
	<property name="webapps.root" value="${build.root}/webapps" />
    <property name="javadoc.output" value="${build.docs}/api" />

    <!-- Set the classpath. -->
	<path id="build.classpath">
		<pathelement location="${build.classes}"/>
		<fileset dir="${build.lib}" includes="*.jar"/>
	</path>

    <!-- TARGETS.... -->

	<target name="build" depends="compile,jar,deploy,create-webapps" description="Build Tinak." />

	<target name="clean">
		<delete dir="${build.classes}" />
		<delete dir="${taglib.classes}" />
		<delete dir="${javadoc.output}" />
		<delete dir="${mock.classes}" />
		<delete dir="${deploy.lib}" />
		<delete>
			<fileset dir="${build.lib}" includes="/milyn-tinak*.jar" />
		</delete>
		<available file="${webapps.root}/tinak-samples" type="dir" property="webapps.installed"/>		
		<antcall target="clean-webapps" />
	</target>
	<target name="clean-webapps" if="webapps.installed">
		<delete failonerror="false">
			<fileset dir="${webapps.root}" includes="*.war" />
			<fileset dir="${webapps.root}/tinak-samples/WEB-INF/lib" excludes="struts.jar" />
		</delete>
	</target>

	<target name="compile">
		<mkdir dir="${build.classes}" />
		<mkdir dir="${taglib.classes}" />
		<mkdir dir="${mock.classes}" />
		<javac srcdir="${build.src}" destdir="${build.classes}" debug="on">
			<classpath refid="build.classpath" />
		</javac>
		<javac srcdir="${taglib.src}" destdir="${taglib.classes}" debug="on">
			<classpath refid="build.classpath" />
		</javac>
		<javac srcdir="${mock.src}" destdir="${mock.classes}" debug="on">
			<classpath refid="build.classpath" />
		</javac>
	</target>

	<target name="jar">
		<mkdir dir="${build.lib}" />
		<mkdir dir="${build.dtd.package}" />
		<copy todir="${build.dtd.package}">
			<fileset dir="${build.root}/dtd"/>
		</copy>
        <jar destfile="${build.lib}/milyn-tinak-${tinak.version}.jar">
			<fileset dir="${build.classes}" excludes="**/*UnitTest.class"/>
			<fileset dir="${build.src}" excludes="**/*.java"/>
            <fileset dir="${taglib.classes}" excludes="**/*$UnitTest.class" />
            <fileset dir="${taglib.src}" includes="META-INF/**" />
		</jar>
        <jar destfile="${build.lib}/milyn-tinak-mocks-${tinak.version}.jar">
            <fileset dir="${mock.classes}" excludes="**/*$UnitTest.class" />
            <fileset dir="${mock.src}" includes="META-INF/**" />
        </jar>
    </target>

	<target name="deploy">
		<mkdir dir="${deploy.lib}" />
        <copy todir="${deploy.lib}">
            <fileset dir="${build.lib}" includes="milyn-tinak*.jar"/>
        </copy>
        <delete>
            <fileset dir="${build.lib}" includes="milyn-tinak*.jar"/>
        </delete>
    </target>

	<target name="create-webapps">
		<!-- 
			If the tinak-samples webapp isn't available it means non are 
			available e.g. the sourceforge distribution.
		-->
		<available file="${webapps.root}/tinak-samples" type="dir" property="webapps.installed"/>		
		<antcall target="_create-webapps" />
    </target>
	<target name="_create-webapps" if="webapps.installed">
		<antcall target="clean-webapps" />

		<!-- tinak-samples webapp -->
		<copy todir="${webapps.root}/tinak-samples/WEB-INF/lib" >
			<fileset dir="${deploy.lib}"/>
			<fileset dir="${build.lib}" excludes="servlet.jar"/>
		</copy>
        <jar destfile="${webapps.root}/tinak-samples.war" basedir="${webapps.root}/tinak-samples" />
    </target>

	<target name="javadoc">
		<mkdir dir="${javadoc.output}"/>
		<javadoc classpathref="build.classpath" destdir="${javadoc.output}" failonerror="true" windowtitle="Milyn-Tinak" overview="${build.src}/overview.html" stylesheetfile="build/stylesheet.css">
			<packageset dir="${build.src}" excludes="**/*UnitTest"/>
			<packageset dir="${taglib.src}"/>
            <doctitle>
                <![CDATA[<h1>Milyn-Tinak</h1>Version ${tinak.version}]]>
            </doctitle>
            <header>
                <![CDATA[<a href="http://www.milyn.org/tinak/" target="top">Milyn-Tinak</a> Version ${tinak.version}]]>
            </header>
			<link offline="true" href="http://www.milyn.org/commons/" packagelistLoc="javadoc-package-lists/commons"/>
		</javadoc>
	</target>
	
</project>

